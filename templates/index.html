<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEA DHCP Lease Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f5f5f5;
        }
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .card {
            box-shadow: 0 2px 8px rgba(0,0,0,.1);
            margin-bottom: 20px;
        }
        .table-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
        }
        .status-badge {
            font-size: 0.85em;
        }
        .action-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        .connection-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .connection-status.online {
            background-color: #28a745;
        }
        .connection-status.offline {
            background-color: #dc3545;
        }
        .lease-state-0 { color: #28a745; }
        .lease-state-1 { color: #6c757d; }
        .lease-state-2 { color: #ffc107; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-diagram-3"></i> KEA DHCP Lease Manager
            </span>
            <div class="text-white">
                <span id="connection-status">
                    <span class="connection-status offline"></span>
                    <span id="status-text">Checking connection...</span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- Filters and Actions -->
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="subnet-filter" class="form-label">Filter by Subnet</label>
                <select class="form-select" id="subnet-filter">
                    <option value="">All Subnets</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="search-filter" class="form-label">Search</label>
                <input type="text" class="form-control" id="search-filter" placeholder="Search by IP, MAC, or hostname...">
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button class="btn btn-primary me-2" onclick="refreshData()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <button class="btn btn-outline-secondary" onclick="showReservations()">
                    <i class="bi bi-bookmark-check"></i> View Reservations
                </button>
            </div>
        </div>

        <!-- Leases Table -->
        <div class="table-container">
            <h4 class="mb-3">
                <i class="bi bi-list-ul"></i> Active DHCP Leases
                <span id="lease-count" class="badge bg-secondary">0</span>
            </h4>
            
            <div id="loading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading leases...</p>
            </div>

            <div id="error-message" class="alert alert-danger" style="display: none;">
                <h5><i class="bi bi-exclamation-triangle"></i> Error Loading Leases</h5>
                <p id="error-text"></p>
                <div id="setup-help" style="display: none;" class="mt-3">
                    <strong>Solution:</strong> Enable the KEA lease_cmds hook library
                    <ol class="mt-2 mb-0">
                        <li>Edit your KEA configuration file (usually <code>/etc/kea/kea-dhcp4.conf</code>)</li>
                        <li>Add the lease_cmds hook library:
                            <pre class="bg-dark text-light p-2 mt-2"><code>"hooks-libraries": [
  {
    "library": "/usr/lib/x86_64-linux-gnu/kea/hooks/libdhcp_lease_cmds.so"
  }
]</code></pre>
                        </li>
                        <li>Restart KEA: <code>sudo systemctl restart kea-dhcp4-server kea-ctrl-agent</code></li>
                    </ol>
                    <a href="https://github.com/awkto/Kea-GUI-Reservations/blob/main/KEA_SETUP_GUIDE.md" 
                       target="_blank" class="btn btn-sm btn-primary mt-2">
                        <i class="bi bi-book"></i> View Full Setup Guide
                    </a>
                </div>
            </div>

            <div id="leases-table-container" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>IP Address</th>
                                <th>MAC Address</th>
                                <th>Hostname</th>
                                <th>Subnet ID</th>
                                <th>Valid Until</th>
                                <th>State</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leases-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Promotion Confirmation Modal -->
    <div class="modal fade" id="promoteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Promote Lease to Reservation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to promote this lease to a permanent reservation?</p>
                    <dl class="row">
                        <dt class="col-sm-4">IP Address:</dt>
                        <dd class="col-sm-8" id="modal-ip"></dd>
                        <dt class="col-sm-4">MAC Address:</dt>
                        <dd class="col-sm-8" id="modal-mac"></dd>
                        <dt class="col-sm-4">Hostname:</dt>
                        <dd class="col-sm-8" id="modal-hostname"></dd>
                        <dt class="col-sm-4">Subnet ID:</dt>
                        <dd class="col-sm-8" id="modal-subnet"></dd>
                    </dl>
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle"></i>
                        This will create a permanent reservation for this device.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="confirmPromotion()">
                        <i class="bi bi-check-circle"></i> Confirm Promotion
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reservations Modal -->
    <div class="modal fade" id="reservationsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-bookmark-check"></i> Current Reservations
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="reservations-loading" class="text-center py-3">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                    <div id="reservations-content" style="display: none;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>IP Address</th>
                                    <th>MAC Address</th>
                                    <th>Hostname</th>
                                    <th>Subnet</th>
                                </tr>
                            </thead>
                            <tbody id="reservations-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allLeases = [];
        let selectedLease = null;
        let promoteModal = null;
        let reservationsModal = null;

        // Initialize modals
        document.addEventListener('DOMContentLoaded', function() {
            promoteModal = new bootstrap.Modal(document.getElementById('promoteModal'));
            reservationsModal = new bootstrap.Modal(document.getElementById('reservationsModal'));
            
            checkHealth();
            loadSubnets();
            loadLeases();
            
            // Setup search filter
            document.getElementById('search-filter').addEventListener('input', filterLeases);
            document.getElementById('subnet-filter').addEventListener('change', filterLeases);
        });

        async function checkHealth() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                const statusEl = document.querySelector('.connection-status');
                const textEl = document.getElementById('status-text');
                
                if (data.status === 'healthy') {
                    statusEl.classList.remove('offline');
                    statusEl.classList.add('online');
                    textEl.textContent = 'Connected to KEA';
                } else {
                    statusEl.classList.remove('online');
                    statusEl.classList.add('offline');
                    textEl.textContent = 'Connection failed';
                }
            } catch (error) {
                const statusEl = document.querySelector('.connection-status');
                const textEl = document.getElementById('status-text');
                statusEl.classList.remove('online');
                statusEl.classList.add('offline');
                textEl.textContent = 'Connection error';
            }
        }

        async function loadSubnets() {
            try {
                const response = await fetch('/api/subnets');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('subnet-filter');
                    data.subnets.forEach(subnet => {
                        const option = document.createElement('option');
                        option.value = subnet.id;
                        option.textContent = `Subnet ${subnet.id} (${subnet.subnet})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load subnets:', error);
            }
        }

        async function loadLeases() {
            const loading = document.getElementById('loading');
            const errorMsg = document.getElementById('error-message');
            const tableContainer = document.getElementById('leases-table-container');
            
            loading.style.display = 'block';
            errorMsg.style.display = 'none';
            tableContainer.style.display = 'none';
            
            try {
                const response = await fetch('/api/leases');
                const data = await response.json();
                
                if (data.success) {
                    allLeases = data.leases;
                    displayLeases(allLeases);
                    loading.style.display = 'none';
                    tableContainer.style.display = 'block';
                } else {
                    throw new Error(data.error || 'Failed to load leases');
                }
            } catch (error) {
                loading.style.display = 'none';
                const errorText = document.getElementById('error-text');
                const setupHelp = document.getElementById('setup-help');
                
                errorText.textContent = error.message;
                
                // Show setup help if it's a lease command issue
                if (error.message.includes('lease4-get') || 
                    error.message.includes('not supported') ||
                    error.message.includes('hook library')) {
                    setupHelp.style.display = 'block';
                } else {
                    setupHelp.style.display = 'none';
                }
                
                errorMsg.style.display = 'block';
            }
        }

        function displayLeases(leases) {
            const tbody = document.getElementById('leases-tbody');
            const countBadge = document.getElementById('lease-count');
            
            tbody.innerHTML = '';
            countBadge.textContent = leases.length;
            
            if (leases.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No leases found</td></tr>';
                return;
            }
            
            leases.forEach(lease => {
                const row = document.createElement('tr');
                
                const validUntil = lease['valid-lft'] 
                    ? new Date(Date.now() + lease['valid-lft'] * 1000).toLocaleString()
                    : 'N/A';
                
                const stateText = getLeaseStateText(lease.state);
                const stateClass = `lease-state-${lease.state || 0}`;
                
                row.innerHTML = `
                    <td><strong>${lease['ip-address']}</strong></td>
                    <td><code>${lease['hw-address']}</code></td>
                    <td>${lease.hostname || '<em>none</em>'}</td>
                    <td><span class="badge bg-info">${lease['subnet-id']}</span></td>
                    <td>${validUntil}</td>
                    <td><span class="${stateClass}">${stateText}</span></td>
                    <td>
                        <button class="btn btn-success btn-sm action-btn" 
                                onclick='promoteLease(${JSON.stringify(lease)})'>
                            <i class="bi bi-arrow-up-circle"></i> Promote
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function getLeaseStateText(state) {
            const states = {
                0: 'Default',
                1: 'Declined',
                2: 'Expired/Reclaimed'
            };
            return states[state] || 'Unknown';
        }

        function filterLeases() {
            const searchTerm = document.getElementById('search-filter').value.toLowerCase();
            const subnetId = document.getElementById('subnet-filter').value;
            
            let filtered = allLeases;
            
            // Filter by subnet
            if (subnetId) {
                filtered = filtered.filter(lease => 
                    lease['subnet-id'] == subnetId
                );
            }
            
            // Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(lease => 
                    lease['ip-address'].toLowerCase().includes(searchTerm) ||
                    lease['hw-address'].toLowerCase().includes(searchTerm) ||
                    (lease.hostname || '').toLowerCase().includes(searchTerm)
                );
            }
            
            displayLeases(filtered);
        }

        function promoteLease(lease) {
            selectedLease = lease;
            
            document.getElementById('modal-ip').textContent = lease['ip-address'];
            document.getElementById('modal-mac').textContent = lease['hw-address'];
            document.getElementById('modal-hostname').textContent = lease.hostname || 'none';
            document.getElementById('modal-subnet').textContent = lease['subnet-id'];
            
            promoteModal.show();
        }

        async function confirmPromotion() {
            if (!selectedLease) return;
            
            try {
                const response = await fetch('/api/promote', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ip_address: selectedLease['ip-address'],
                        hw_address: selectedLease['hw-address'],
                        hostname: selectedLease.hostname || '',
                        subnet_id: selectedLease['subnet-id']
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    promoteModal.hide();
                    
                    // Show success message
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success alert-dismissible fade show mt-3';
                    alert.innerHTML = `
                        <i class="bi bi-check-circle"></i> ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    
                    // Insert at the top of the container
                    const container = document.querySelector('.container-fluid');
                    const firstChild = container.firstChild;
                    container.insertBefore(alert, firstChild);
                    
                    // Auto-dismiss after 5 seconds
                    setTimeout(() => {
                        alert.remove();
                    }, 5000);
                    
                    // Refresh leases
                    setTimeout(() => loadLeases(), 1000);
                } else {
                    throw new Error(data.error || 'Failed to promote lease');
                }
            } catch (error) {
                promoteModal.hide();
                alert(`Error: ${error.message}`);
            }
        }

        async function showReservations() {
            reservationsModal.show();
            
            document.getElementById('reservations-loading').style.display = 'block';
            document.getElementById('reservations-content').style.display = 'none';
            
            try {
                const response = await fetch('/api/reservations');
                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.getElementById('reservations-tbody');
                    tbody.innerHTML = '';
                    
                    if (data.reservations.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No reservations found</td></tr>';
                    } else {
                        data.reservations.forEach(res => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td><strong>${res['ip-address']}</strong></td>
                                <td><code>${res['hw-address']}</code></td>
                                <td>${res.hostname || '<em>none</em>'}</td>
                                <td>${res.subnet || res['subnet-id']}</td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                    
                    document.getElementById('reservations-loading').style.display = 'none';
                    document.getElementById('reservations-content').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load reservations:', error);
            }
        }

        function refreshData() {
            loadLeases();
            checkHealth();
        }

        // Auto-refresh every 30 seconds
        setInterval(refreshData, 30000);
    </script>
</body>
</html>
