<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEA DHCP Lease Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f5f5f5;
        }
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .card {
            box-shadow: 0 2px 8px rgba(0,0,0,.1);
            margin-bottom: 20px;
        }
        .table-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
        }
        .status-badge {
            font-size: 0.85em;
        }
        .connection-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .connection-status.online {
            background-color: #28a745;
        }
        .connection-status.offline {
            background-color: #dc3545;
        }
        .version-toggle {
            cursor: default;
        }
        .version-number {
            font-size: 0.7rem;
            margin-left: 8px;
            opacity: 0.8;
            vertical-align: middle;
        }
        #login-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-card {
            background: white;
            border-radius: 12px;
            padding: 2.5rem;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <!-- Login Overlay -->
    <div id="login-overlay">
        <div class="login-card">
            <div class="text-center mb-4">
                <i class="bi bi-shield-lock" style="font-size: 2.5rem; color: #0d6efd;"></i>
                <h4 class="mt-2 mb-1">KEA DHCP Lease Manager</h4>
                <p class="text-muted small mb-0">Enter your admin password to continue</p>
            </div>
            <div class="mb-3">
                <label for="login-password" class="form-label fw-semibold">Password</label>
                <input type="password" class="form-control form-control-lg" id="login-password"
                       placeholder="Enter your password..." autocomplete="current-password">
            </div>
            <div id="login-error" class="alert alert-danger py-2 small" style="display:none;"></div>
            <button class="btn btn-primary btn-lg w-100" onclick="doLogin()">
                <i class="bi bi-box-arrow-in-right me-2"></i>Login
            </button>
        </div>
    </div>

    <!-- First-Run Setup Overlay -->
    <div id="setup-overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background: linear-gradient(135deg, #198754 0%, #146c43 100%); z-index: 10000; align-items:center; justify-content:center;">
        <div class="login-card" style="max-width: 460px;">
            <div class="text-center mb-4">
                <i class="bi bi-shield-check" style="font-size: 2.5rem; color: #198754;"></i>
                <h4 class="mt-2 mb-1">Welcome — First-Time Setup</h4>
                <p class="text-muted small mb-0">Create an admin password to secure this instance</p>
            </div>
            <div class="mb-3">
                <label for="setup-password" class="form-label fw-semibold">Password <span class="text-muted fw-normal">(min. 8 characters)</span></label>
                <input type="password" class="form-control form-control-lg" id="setup-password"
                       placeholder="Choose a password..." autocomplete="new-password">
            </div>
            <div class="mb-4">
                <label for="setup-password-confirm" class="form-label fw-semibold">Confirm Password</label>
                <input type="password" class="form-control form-control-lg" id="setup-password-confirm"
                       placeholder="Repeat password..." autocomplete="new-password">
            </div>
            <div id="setup-error" class="alert alert-danger py-2 small" style="display:none;"></div>
            <button class="btn btn-success btn-lg w-100" onclick="doSetup()" id="setup-btn">
                <i class="bi bi-check-circle me-2"></i>Complete Setup &amp; Log In
            </button>
            <p class="text-center text-muted small mt-3 mb-0">
                An API token is automatically generated for programmatic access.
            </p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-diagram-3 version-toggle" id="versionToggle" title="Click to toggle version"></i> KEA DHCP Lease Manager
                <span class="version-number" id="versionNumber" style="display: none;">v{{ version }}</span>
            </span>
            <div class="d-flex align-items-center">
                <span id="connection-status" class="text-white me-3">
                    <span class="connection-status offline"></span>
                    <span id="status-text">Checking connection...</span>
                </span>
                <button class="btn btn-outline-light btn-sm me-2" onclick="showKeaConfigModal()">
                    <i class="bi bi-file-code"></i> Kea Config
                </button>
                <button class="btn btn-outline-light btn-sm" onclick="showConfigModal()">
                    <i class="bi bi-gear"></i> Edit Configuration
                </button>
                <button class="btn btn-outline-light btn-sm ms-2" onclick="logout()" title="Logout">
                    <i class="bi bi-box-arrow-right"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- Filters and Actions -->
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="subnet-filter" class="form-label">Filter by Subnet</label>
                <select class="form-select" id="subnet-filter">
                    <option value="">All Subnets</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="search-filter" class="form-label">Search</label>
                <input type="text" class="form-control" id="search-filter" placeholder="Search by IP, MAC, or hostname...">
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button class="btn btn-light me-2" onclick="refreshData()" style="border: 1px solid #dee2e6;">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <button class="btn btn-success me-2" onclick="showAddReservationModal()">
                    <i class="bi bi-plus-circle"></i> Add Reservation
                </button>
                <button class="btn me-2" onclick="showReservations()" style="background-color: #ffc107; border-color: #ffc107; color: #212529; opacity: 0.75;">
                    <i class="bi bi-bookmark-check"></i> View Reservations
                </button>
            </div>
        </div>

        <!-- Leases Table -->
        <div class="table-container">
            <h4 class="mb-3">
                <i class="bi bi-list-ul"></i> Active DHCP Leases
                <span id="lease-count" class="badge bg-secondary">0</span>
            </h4>
            
            <div id="loading" class="text-center py-5" style="display:none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading leases...</p>
            </div>

            <div id="error-message" class="alert alert-danger" style="display: none;">
                <h5><i class="bi bi-exclamation-triangle"></i> Error Loading Leases</h5>
                <p id="error-text"></p>
                <div id="setup-help" style="display: none;" class="mt-3">
                    <strong>Solution:</strong> Enable the KEA lease_cmds hook library
                    <ol class="mt-2 mb-0">
                        <li>Edit your KEA configuration file (usually <code>/etc/kea/kea-dhcp4.conf</code>)</li>
                        <li>Add the lease_cmds hook library:
                            <pre class="bg-dark text-light p-2 mt-2"><code>"hooks-libraries": [
  {
    "library": "/usr/lib/x86_64-linux-gnu/kea/hooks/libdhcp_lease_cmds.so"
  }
]</code></pre>
                        </li>
                        <li>Restart KEA: <code>sudo systemctl restart kea-dhcp4-server kea-ctrl-agent</code></li>
                    </ol>
                    <a href="https://github.com/awkto/Kea-GUI-Reservations/blob/main/KEA_SETUP_GUIDE.md" 
                       target="_blank" class="btn btn-sm btn-primary mt-2">
                        <i class="bi bi-book"></i> View Full Setup Guide
                    </a>
                </div>
            </div>

            <div id="unconfigured-message" style="display:none; text-align:center; padding: 3rem 1rem;">
                <i class="bi bi-gear" style="font-size: 2.5rem; color: #adb5bd;"></i>
                <h5 class="mt-3 mb-1 text-muted">KEA Not Configured</h5>
                <p class="text-muted mb-3">Click <strong>Edit Configuration</strong> in the top-right to connect to your KEA DHCP server.</p>
            </div>

            <div id="leases-table-container" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>IP Address</th>
                                <th>MAC Address</th>
                                <th>Hostname</th>
                                <th>Subnet ID</th>
                                <th>Valid Until</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leases-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Promotion Confirmation Modal -->
    <div class="modal fade" id="promoteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Promote Lease to Reservation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Configure the permanent reservation for this device:</p>
                    <form id="promote-form">
                        <div class="mb-3">
                            <label for="promote-ip-address" class="form-label">IP Address *</label>
                            <input type="text" class="form-control" id="promote-ip-address" 
                                   placeholder="192.168.1.100" required>
                            <div class="form-text">You can change the IP address. Defaults to the lease's current IP.</div>
                            <div id="ip-validation-message" class="mt-2" style="display: none;"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">MAC Address</label>
                            <input type="text" class="form-control" id="promote-mac-address" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="promote-hostname" class="form-label">Hostname</label>
                            <input type="text" class="form-control" id="promote-hostname"
                                   placeholder="Optional hostname for this device">
                            <div class="form-text">You can change or add a hostname for this reservation.</div>
                        </div>
                        <div class="mb-3">
                            <label for="promote-dns-servers" class="form-label">Custom DNS Servers</label>
                            <input type="text" class="form-control" id="promote-dns-servers"
                                   placeholder="e.g., 8.8.8.8, 8.8.4.4 (leave empty for subnet default)">
                            <div class="form-text">Specify custom DNS servers for this device only. Comma-separated IP addresses.</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Subnet ID</label>
                            <div id="promote-subnet" class="form-control-plaintext"></div>
                        </div>
                    </form>
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle"></i>
                        This will create a permanent reservation for this device.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="confirmPromotion()" id="confirm-promote-btn">
                        <i class="bi bi-check-circle"></i> Confirm Promotion
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reservations Modal -->
    <div class="modal fade" id="reservationsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h5 class="modal-title">
                        <i class="bi bi-bookmark-check"></i> Current Reservations
                    </h5>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="btn-group">
                            <button class="btn btn-info btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-download"></i> Import/Export
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" onclick="exportReservations(); return false;">
                                    <i class="bi bi-download"></i> Export Reservations
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="showImportModal(); return false;">
                                    <i class="bi bi-upload"></i> Import Reservations
                                </a></li>
                            </ul>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div id="reservations-loading" class="text-center py-3">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                    <div id="reservations-content" style="display: none;">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>IP Address</th>
                                    <th>MAC Address</th>
                                    <th>Hostname</th>
                                    <th>Subnet</th>
                                    <th>DNS Servers</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reservations-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Reservation Modal -->
    <div class="modal fade" id="addReservationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle"></i> Add Manual Reservation
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-reservation-form">
                        <div class="mb-3">
                            <label for="new-ip-address" class="form-label">IP Address *</label>
                            <input type="text" class="form-control" id="new-ip-address" 
                                   placeholder="192.168.1.100" required>
                        </div>
                        <div class="mb-3">
                            <label for="new-hw-address" class="form-label">MAC Address *</label>
                            <input type="text" class="form-control" id="new-hw-address" 
                                   placeholder="aa:bb:cc:dd:ee:ff" required>
                        </div>
                        <div class="mb-3">
                            <label for="new-hostname" class="form-label">Hostname</label>
                            <input type="text" class="form-control" id="new-hostname"
                                   placeholder="my-device">
                        </div>
                        <div class="mb-3">
                            <label for="new-dns-servers" class="form-label">Custom DNS Servers</label>
                            <input type="text" class="form-control" id="new-dns-servers"
                                   placeholder="e.g., 8.8.8.8, 8.8.4.4 (leave empty for subnet default)">
                            <div class="form-text">Specify custom DNS servers for this device only. Comma-separated IP addresses.</div>
                        </div>
                        <div class="mb-3">
                            <label for="new-subnet-id" class="form-label">Subnet</label>
                            <select class="form-select" id="new-subnet-id">
                                <option value="">Auto-detect</option>
                            </select>
                        </div>
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle"></i>
                            This will create a permanent DHCP reservation for the specified device.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="confirmAddReservation()">
                        <i class="bi bi-check-circle"></i> Create Reservation
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Reservation Modal -->
    <div class="modal fade" id="editReservationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil"></i> Edit Reservation
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-reservation-form">
                        <div class="mb-3">
                            <label for="edit-ip-address" class="form-label">IP Address *</label>
                            <input type="text" class="form-control" id="edit-ip-address" 
                                   placeholder="192.168.1.100" required readonly>
                            <div class="form-text">IP address cannot be changed. Delete and recreate to change IP.</div>
                        </div>
                        <div class="mb-3">
                            <label for="edit-hw-address" class="form-label">MAC Address *</label>
                            <input type="text" class="form-control" id="edit-hw-address" 
                                   placeholder="aa:bb:cc:dd:ee:ff" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-hostname" class="form-label">Hostname</label>
                            <input type="text" class="form-control" id="edit-hostname"
                                   placeholder="my-device">
                        </div>
                        <div class="mb-3">
                            <label for="edit-dns-servers" class="form-label">Custom DNS Servers</label>
                            <input type="text" class="form-control" id="edit-dns-servers"
                                   placeholder="e.g., 8.8.8.8, 8.8.4.4 (leave empty for subnet default)">
                            <div class="form-text">Specify custom DNS servers for this device only. Comma-separated IP addresses.</div>
                        </div>
                        <div class="mb-3">
                            <label for="edit-subnet-id" class="form-label">Subnet</label>
                            <select class="form-select" id="edit-subnet-id">
                                <option value="">Auto-detect</option>
                            </select>
                        </div>
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle"></i>
                            Editing will delete the old reservation and create a new one with the updated values.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmEditReservation()">
                        <i class="bi bi-check-circle"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Reservation Confirmation Modal -->
    <div class="modal fade" id="deleteReservationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle"></i> Delete Reservation
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this reservation?</p>
                    <dl class="row">
                        <dt class="col-sm-4">IP Address:</dt>
                        <dd class="col-sm-8" id="delete-modal-ip"></dd>
                        <dt class="col-sm-4">MAC Address:</dt>
                        <dd class="col-sm-8" id="delete-modal-mac"></dd>
                        <dt class="col-sm-4">Hostname:</dt>
                        <dd class="col-sm-8" id="delete-modal-hostname"></dd>
                    </dl>
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle"></i>
                        This action cannot be undone. The device will receive a dynamic lease on next DHCP request.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteReservation()">
                        <i class="bi bi-trash"></i> Delete Reservation
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Lease Confirmation Modal -->
    <div class="modal fade" id="deleteLeaseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle"></i> Delete Lease
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Lease will be deleted. Client reboot recommended.</p>
                    <dl class="row mb-0">
                        <dt class="col-sm-4">IP Address:</dt>
                        <dd class="col-sm-8" id="delete-lease-modal-ip"></dd>
                        <dt class="col-sm-4">MAC Address:</dt>
                        <dd class="col-sm-8" id="delete-lease-modal-mac"></dd>
                        <dt class="col-sm-4">Hostname:</dt>
                        <dd class="col-sm-8 mb-0" id="delete-lease-modal-hostname"></dd>
                    </dl>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteLease()">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Modal -->
    <div class="modal fade" id="configModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-gear"></i> Configuration Settings
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="config-loading" class="text-center py-3">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Loading configuration...</p>
                    </div>
                    
                    <form id="config-form" style="display: none;">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            Configure your KEA DHCP server connection and application settings.
                            <div id="config-file-status" class="mt-2"></div>
                        </div>
                        
                        <h6 class="border-bottom pb-2 mb-3">KEA DHCP Server Settings</h6>
                        
                        <div class="mb-3">
                            <label for="config-kea-url" class="form-label">Control Agent URL *</label>
                            <input type="text" class="form-control" id="config-kea-url" 
                                   placeholder="http://localhost:8000" required>
                            <div class="form-text">The URL of the KEA Control Agent API</div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="config-kea-username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="config-kea-username" 
                                       placeholder="Optional">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="config-kea-password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="config-kea-password" 
                                       placeholder="Optional">
                                <div class="form-text">Leave as *** to keep existing password</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="config-kea-subnet" class="form-label">Default Subnet ID</label>
                            <input type="number" class="form-control" id="config-kea-subnet" value="1">
                        </div>
                        
                        <h6 class="border-bottom pb-2 mb-3 mt-4">Application Settings</h6>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="config-app-host" class="form-label">Host</label>
                                <input type="text" class="form-control" id="config-app-host" value="0.0.0.0">
                                <div class="form-text">0.0.0.0 to listen on all interfaces</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="config-app-port" class="form-label">Port</label>
                                <input type="number" class="form-control" id="config-app-port" value="5000">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="config-app-debug">
                                <label class="form-check-label" for="config-app-debug">
                                    Debug Mode
                                </label>
                                <div class="form-text">Enable Flask debug mode (not recommended for production)</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="config-confirm-lease-delete" checked>
                                <label class="form-check-label" for="config-confirm-lease-delete">
                                    Confirm lease deletion
                                </label>
                                <div class="form-text">Show a confirmation dialog before deleting a lease</div>
                            </div>
                        </div>

                        <h6 class="border-bottom pb-2 mb-3 mt-4">Logging Settings</h6>

                        <div class="mb-3">
                            <label for="config-log-level" class="form-label">Log Level</label>
                            <select class="form-select" id="config-log-level">
                                <option value="DEBUG">DEBUG</option>
                                <option value="INFO" selected>INFO</option>
                                <option value="WARNING">WARNING</option>
                                <option value="ERROR">ERROR</option>
                            </select>
                        </div>

                        <h6 class="border-bottom pb-2 mb-3 mt-4">API Access</h6>

                        <div class="mb-3">
                            <label class="form-label">API Token</label>
                            <div class="input-group">
                                <input type="password" class="form-control font-monospace" id="config-api-token" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="toggleApiTokenVisibility()" id="api-token-toggle-btn" title="Show/hide token">
                                    <i class="bi bi-eye" id="api-token-eye-icon"></i>
                                </button>
                                <button class="btn btn-outline-secondary" type="button" onclick="copyApiToken()" title="Copy to clipboard">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                            <div class="form-text">Use this token as a Bearer token for programmatic API access.</div>
                        </div>
                        <button class="btn btn-outline-danger btn-sm" type="button" onclick="regenerateApiToken()">
                            <i class="bi bi-arrow-repeat me-1"></i>Regenerate API Token
                        </button>
                        <div class="form-text mt-1">Regenerating invalidates all existing API sessions.</div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveConfiguration()" id="save-config-btn">
                        <i class="bi bi-save"></i> Save Configuration
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Reservations Modal -->
    <div class="modal fade" id="importModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-upload"></i> Import Reservations
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="import-file-select" style="display: block;">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            Upload a JSON file containing DHCP reservations. The file should contain an array of reservation objects or an object with a "reservations" property.
                        </div>
                        
                        <div class="mb-3">
                            <label for="import-file" class="form-label">Select JSON File</label>
                            <input type="file" class="form-control" id="import-file" accept=".json" required>
                            <div class="form-text">Accepted format: JSON file exported from this application or compatible format</div>
                        </div>
                        
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Note:</strong> Each reservation will be created individually. If a reservation fails (e.g., duplicate or invalid subnet), the import will continue with the remaining reservations.
                        </div>
                    </div>
                    
                    <div id="import-progress" style="display: none;">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2">Importing reservations, please wait...</p>
                        </div>
                    </div>
                    
                    <div id="import-results" style="display: none;">
                        <div id="import-summary" class="mb-3"></div>
                        <div id="import-failed-items" style="display: none;">
                            <h6>Failed Imports:</h6>
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-bordered">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>IP Address</th>
                                            <th>MAC Address</th>
                                            <th>Error</th>
                                        </tr>
                                    </thead>
                                    <tbody id="failed-items-tbody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="confirmImport()" id="import-btn">
                        <i class="bi bi-upload"></i> Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Kea Config Modal -->
    <div class="modal fade" id="keaConfigModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-file-code"></i> Kea DHCP Configuration
                    </h5>
                    <div class="btn-group ms-auto me-3" role="group">
                        <input type="radio" class="btn-check" name="keaConfigView" id="viewCurated" autocomplete="off" checked>
                        <label class="btn btn-outline-light btn-sm" for="viewCurated">Curated</label>
                        <input type="radio" class="btn-check" name="keaConfigView" id="viewRaw" autocomplete="off">
                        <label class="btn btn-outline-light btn-sm" for="viewRaw">Raw JSON</label>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Loading spinner -->
                    <div id="kea-config-loading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading Kea configuration...</p>
                    </div>

                    <!-- Error message -->
                    <div id="kea-config-error" class="alert alert-danger" style="display: none;">
                        <h5><i class="bi bi-exclamation-triangle"></i> Error Loading Configuration</h5>
                        <p id="kea-config-error-text"></p>
                    </div>

                    <!-- Curation warning -->
                    <div id="kea-config-curation-warning" class="alert alert-warning" style="display: none;">
                        <h6><i class="bi bi-exclamation-triangle"></i> Curated View Unavailable</h6>
                        <p id="kea-config-curation-warning-text"></p>
                        <p class="mb-0"><strong>Raw JSON view is still available below.</strong></p>
                    </div>

                    <!-- Curated view -->
                    <div id="kea-config-curated" style="display: none;">
                        <div class="accordion" id="keaConfigAccordion">
                            <!-- Global Settings -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGlobal" aria-expanded="true" aria-controls="collapseGlobal">
                                        <i class="bi bi-globe me-2"></i> Global Settings
                                    </button>
                                </h2>
                                <div id="collapseGlobal" class="accordion-collapse collapse show" data-bs-parent="#keaConfigAccordion">
                                    <div class="accordion-body" id="global-settings-content">
                                        <!-- Global settings will be populated here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Subnets container - will be populated dynamically -->
                            <div id="subnets-accordion-container"></div>

                            <!-- Advanced Settings -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdvanced" aria-expanded="false" aria-controls="collapseAdvanced">
                                        <i class="bi bi-gear-wide-connected me-2"></i> Advanced Settings
                                    </button>
                                </h2>
                                <div id="collapseAdvanced" class="accordion-collapse collapse" data-bs-parent="#keaConfigAccordion">
                                    <div class="accordion-body" id="advanced-settings-content">
                                        <!-- Advanced settings will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Raw JSON view -->
                    <div id="kea-config-raw" style="display: none;">
                        <pre id="kea-config-json" class="bg-dark text-light p-3 rounded" style="max-height: 70vh; overflow-y: auto; font-size: 0.85rem;"><code></code></pre>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ── Authentication ────────────────────────────────────────────────────────
        const AUTH_TOKEN_KEY = 'kea_auth_token';

        function getAuthToken() {
            return localStorage.getItem(AUTH_TOKEN_KEY);
        }

        function getAuthHeaders(extra) {
            const headers = { 'Authorization': 'Bearer ' + (getAuthToken() || '') };
            return extra ? Object.assign(headers, extra) : headers;
        }

        async function authFetch(url, options = {}) {
            options.headers = getAuthHeaders(options.headers);
            const response = await fetch(url, options);
            if (response.status === 401) {
                logout();
                throw new Error('Session expired. Please log in again.');
            }
            return response;
        }

        async function doLogin() {
            const passwordInput = document.getElementById('login-password');
            const errorEl = document.getElementById('login-error');
            const password = passwordInput.value;
            if (!password) {
                errorEl.textContent = 'Please enter your password.';
                errorEl.style.display = 'block';
                return;
            }
            try {
                const resp = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                const data = await resp.json();
                if (data.success) {
                    localStorage.setItem(AUTH_TOKEN_KEY, data.session_token);
                    document.getElementById('login-overlay').style.display = 'none';
                    initApp();
                } else {
                    errorEl.textContent = data.error || 'Invalid password.';
                    errorEl.style.display = 'block';
                }
            } catch (err) {
                errorEl.textContent = 'Login failed: ' + err.message;
                errorEl.style.display = 'block';
            }
        }

        function logout() {
            // Revoke session server-side (fire-and-forget)
            const token = getAuthToken();
            if (token) {
                fetch('/api/logout', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                }).catch(() => {});
            }
            localStorage.removeItem(AUTH_TOKEN_KEY);
            document.getElementById('login-password').value = '';
            document.getElementById('login-error').style.display = 'none';
            document.getElementById('login-overlay').style.display = 'flex';
        }

        async function checkExistingAuth() {
            const token = getAuthToken();
            if (!token) return false;
            try {
                const resp = await fetch('/api/health', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                return resp.status !== 401;
            } catch {
                return false;
            }
        }
        // ─────────────────────────────────────────────────────────────────────────

        let allLeases = [];
        let allReservations = [];
        let selectedLease = null;
        let selectedReservation = null;
        let editingReservation = null;
        let promoteModal = null;
        let reservationsModal = null;
        let addReservationModal = null;
        let editReservationModal = null;
        let deleteReservationModal = null;
        let deleteLeaseModal = null;
        let configModal = null;
        let importModal = null;
        let keaConfigModal = null;
        let keaConfigData = null;
        let confirmLeaseDelete = localStorage.getItem('confirmLeaseDelete') !== 'false';

        // Initialize modals
        document.addEventListener('DOMContentLoaded', function() {
            promoteModal = new bootstrap.Modal(document.getElementById('promoteModal'));
            reservationsModal = new bootstrap.Modal(document.getElementById('reservationsModal'));
            addReservationModal = new bootstrap.Modal(document.getElementById('addReservationModal'));
            editReservationModal = new bootstrap.Modal(document.getElementById('editReservationModal'));
            deleteReservationModal = new bootstrap.Modal(document.getElementById('deleteReservationModal'));
            deleteLeaseModal = new bootstrap.Modal(document.getElementById('deleteLeaseModal'));
            configModal = new bootstrap.Modal(document.getElementById('configModal'));
            importModal = new bootstrap.Modal(document.getElementById('importModal'));
            keaConfigModal = new bootstrap.Modal(document.getElementById('keaConfigModal'));

            // Setup Kea Config view toggle
            document.getElementById('viewCurated').addEventListener('change', function() {
                if (this.checked) {
                    document.getElementById('kea-config-curated').style.display = 'block';
                    document.getElementById('kea-config-raw').style.display = 'none';
                }
            });
            document.getElementById('viewRaw').addEventListener('change', function() {
                if (this.checked) {
                    document.getElementById('kea-config-curated').style.display = 'none';
                    document.getElementById('kea-config-raw').style.display = 'block';
                }
            });

            // Setup version toggle
            document.getElementById('versionToggle').addEventListener('click', toggleVersion);

            // Allow Enter key on login form
            document.getElementById('login-password').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') doLogin();
            });

            // Allow Enter key on setup form (confirm field)
            document.getElementById('setup-password-confirm').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') doSetup();
            });

            // Setup search filter
            document.getElementById('search-filter').addEventListener('input', filterLeases);
            document.getElementById('subnet-filter').addEventListener('change', filterLeases);

            // Check first-run status, then auth, then load app
            checkFirstRun().then(isFirstRun => {
                if (isFirstRun) {
                    document.getElementById('login-overlay').style.display = 'none';
                    const overlay = document.getElementById('setup-overlay');
                    overlay.style.display = 'flex';
                } else {
                    checkExistingAuth().then(valid => {
                        if (valid) {
                            document.getElementById('login-overlay').style.display = 'none';
                            initApp();
                        }
                        // else: login overlay stays visible
                    });
                }
            });
        });

        async function checkFirstRun() {
            try {
                const resp = await fetch('/api/first-run');
                const data = await resp.json();
                return data.first_run === true;
            } catch {
                return false;
            }
        }

        async function doSetup() {
            const password = document.getElementById('setup-password').value;
            const confirm = document.getElementById('setup-password-confirm').value;
            const errorEl = document.getElementById('setup-error');
            const btn = document.getElementById('setup-btn');

            errorEl.style.display = 'none';

            if (!password || password.length < 8) {
                errorEl.textContent = 'Password must be at least 8 characters.';
                errorEl.style.display = 'block';
                return;
            }
            if (password !== confirm) {
                errorEl.textContent = 'Passwords do not match.';
                errorEl.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Setting up...';

            try {
                const resp = await fetch('/api/setup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                const data = await resp.json();
                if (data.success) {
                    localStorage.setItem(AUTH_TOKEN_KEY, data.session_token);
                    document.getElementById('setup-overlay').style.display = 'none';
                    initApp();
                } else {
                    errorEl.textContent = data.error || 'Setup failed.';
                    errorEl.style.display = 'block';
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Complete Setup &amp; Log In';
                }
            } catch (err) {
                errorEl.textContent = 'Setup failed: ' + err.message;
                errorEl.style.display = 'block';
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Complete Setup &amp; Log In';
            }
        }

        function showUnconfiguredState() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('leases-table-container').style.display = 'none';
            document.getElementById('unconfigured-message').style.display = 'block';
        }

        async function initApp() {
            const health = await checkHealth();
            if (!health || health.status === 'unconfigured') {
                showUnconfiguredState();
                return;
            }
            document.getElementById('loading').style.display = 'block';
            loadSubnets();
            loadReservations().then(() => {
                loadLeases();
            });
        }

        function toggleVersion() {
            const versionNumber = document.getElementById('versionNumber');
            if (versionNumber.style.display === 'none') {
                versionNumber.style.display = 'inline';
            } else {
                versionNumber.style.display = 'none';
            }
        }

        async function checkHealth() {
            try {
                const response = await authFetch('/api/health');
                const data = await response.json();
                
                const statusEl = document.querySelector('.connection-status');
                const textEl = document.getElementById('status-text');
                
                if (data.status === 'healthy') {
                    statusEl.classList.remove('offline');
                    statusEl.classList.add('online');
                    textEl.textContent = 'Connected to KEA';
                } else if (data.status === 'unconfigured') {
                    statusEl.classList.remove('online');
                    statusEl.classList.add('offline');
                    textEl.textContent = 'Not Configured';
                } else {
                    statusEl.classList.remove('online');
                    statusEl.classList.add('offline');
                    textEl.textContent = 'Connection failed';
                }
                
                return data;
            } catch (error) {
                const statusEl = document.querySelector('.connection-status');
                const textEl = document.getElementById('status-text');
                statusEl.classList.remove('online');
                statusEl.classList.add('offline');
                textEl.textContent = 'Connection error';
                return null;
            }
        }

        async function loadSubnets() {
            try {
                const response = await authFetch('/api/subnets');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('subnet-filter');
                    const newSubnetSelect = document.getElementById('new-subnet-id');
                    const editSubnetSelect = document.getElementById('edit-subnet-id');
                    
                    data.subnets.forEach(subnet => {
                        const option = document.createElement('option');
                        option.value = subnet.id;
                        option.textContent = `Subnet ${subnet.id} (${subnet.subnet})`;
                        select.appendChild(option);
                        
                        // Also add to the add reservation modal
                        const newOption = option.cloneNode(true);
                        newSubnetSelect.appendChild(newOption);
                        
                        // Also add to the edit reservation modal
                        const editOption = option.cloneNode(true);
                        editSubnetSelect.appendChild(editOption);
                    });
                }
            } catch (error) {
                console.error('Failed to load subnets:', error);
            }
        }

        async function loadReservations() {
            try {
                const response = await authFetch('/api/reservations');
                const data = await response.json();
                
                if (data.success) {
                    allReservations = data.reservations;
                }
            } catch (error) {
                console.error('Failed to load reservations:', error);
                allReservations = [];
            }
        }

        async function loadLeases() {
            const loading = document.getElementById('loading');
            const errorMsg = document.getElementById('error-message');
            const tableContainer = document.getElementById('leases-table-container');
            
            loading.style.display = 'block';
            errorMsg.style.display = 'none';
            tableContainer.style.display = 'none';
            
            try {
                const response = await authFetch('/api/leases');
                const data = await response.json();
                
                if (data.success) {
                    allLeases = data.leases;
                    displayLeases(allLeases);
                    loading.style.display = 'none';
                    tableContainer.style.display = 'block';
                } else if (data.unconfigured) {
                    // Show unconfigured state message
                    loading.style.display = 'none';
                    const errorText = document.getElementById('error-text');
                    errorText.textContent = data.error;
                    document.getElementById('setup-help').style.display = 'none';
                    errorMsg.style.display = 'block';
                } else {
                    throw new Error(data.error || 'Failed to load leases');
                }
            } catch (error) {
                loading.style.display = 'none';
                const errorText = document.getElementById('error-text');
                const setupHelp = document.getElementById('setup-help');
                
                errorText.textContent = error.message;
                
                // Show setup help if it's a lease command issue
                if (error.message.includes('lease4-get') || 
                    error.message.includes('not supported') ||
                    error.message.includes('hook library')) {
                    setupHelp.style.display = 'block';
                } else {
                    setupHelp.style.display = 'none';
                }
                
                errorMsg.style.display = 'block';
            }
        }

        function displayLeases(leases) {
            const tbody = document.getElementById('leases-tbody');
            const countBadge = document.getElementById('lease-count');
            
            tbody.innerHTML = '';
            countBadge.textContent = leases.length;
            
            if (leases.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No leases found</td></tr>';
                return;
            }
            
            leases.forEach(lease => {
                const row = document.createElement('tr');
                
                // Calculate valid until time
                // KEA provides either 'expire' (absolute timestamp) or 'cltt' + 'valid-lft'
                let validUntil = 'N/A';
                if (lease['expire']) {
                    // Expire is an absolute Unix timestamp
                    validUntil = new Date(lease['expire'] * 1000).toLocaleString();
                } else if (lease['cltt'] && lease['valid-lft']) {
                    // Calculate from client last transaction time + valid lifetime
                    validUntil = new Date((lease['cltt'] + lease['valid-lft']) * 1000).toLocaleString();
                } else if (lease['valid-lft']) {
                    // Fallback to current time + valid lifetime (may be inaccurate)
                    validUntil = new Date(Date.now() + lease['valid-lft'] * 1000).toLocaleString();
                }
                
                // Check if this lease has a matching reservation
                // Three cases:
                // 1. Reserved: Reservation exists for same IP
                // 2. Evicting: Reservation exists for same MAC but different IP
                // 3. Available: No reservation exists
                const reservationForSameIP = allReservations.find(res => 
                    res['ip-address'] === lease['ip-address']
                );
                const reservationForSameMAC = allReservations.find(res => 
                    res['hw-address'] === lease['hw-address']
                );
                
                let actionButton;
                if (reservationForSameIP) {
                    // Lease IP has a reservation - it's properly reserved
                    actionButton = `<span class="badge rounded-pill d-inline-flex align-items-center justify-content-center gap-1" 
                            style="font-size: 0.813rem; padding: 0.4rem 0.75rem; font-weight: 500; cursor: not-allowed; background-color: #d3d3d3; color: #6c757d; height: 30px; line-height: 1.5; min-width: 105px;"
                            title="This IP has a permanent reservation">
                           <i class="bi bi-lock-fill" style="font-size: 0.75rem;"></i>
                           <span>Reserved</span>
                       </span>`;
                } else if (reservationForSameMAC && reservationForSameMAC['ip-address'] !== lease['ip-address']) {
                    // MAC has a reservation but for a different IP - lease is being evicted
                    const reservedIP = reservationForSameMAC['ip-address'];
                    actionButton = `<span class="badge rounded-pill d-inline-flex align-items-center justify-content-center gap-1" 
                            style="font-size: 0.813rem; padding: 0.4rem 0.75rem; font-weight: 500; cursor: pointer; background-color: #c8b5e6; color: #4a2c7a; height: 30px; line-height: 1.5; min-width: 105px;"
                            title="New Reserved IP: ${reservedIP}"
                            onclick='showEvictionDetails("${lease['ip-address']}", "${reservedIP}", "${lease['hw-address']}"); event.stopPropagation();'>
                           <i class="bi bi-arrow-right-circle-fill" style="font-size: 0.75rem;"></i>
                           <span>Evicting</span>
                       </span>`;
                } else {
                    // No reservation - can be promoted
                    actionButton = `<button class="btn btn-success btn-sm rounded-pill d-inline-flex align-items-center justify-content-center gap-1" 
                               style="font-size: 0.813rem; padding: 0.4rem 0.75rem; font-weight: 500; border: none; transition: all 0.2s ease; height: 30px; line-height: 1; min-width: 105px;"
                               onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.15)'"
                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                               title="Convert this lease into a permanent reservation"
                               onclick='promoteLease(${JSON.stringify(lease)})'>
                           <i class="bi bi-arrow-up-circle-fill" style="font-size: 0.875rem;"></i>
                           <span>Promote</span>
                       </button>`;
                }
                
                const deleteButton = `<button class="btn btn-sm rounded-circle d-inline-flex align-items-center justify-content-center"
                        style="width:30px;height:30px;padding:0;border:1px solid #dc3545;color:#dc3545;background:transparent;flex-shrink:0"
                        onmouseover="this.style.background='#dc3545';this.style.color='white'"
                        onmouseout="this.style.background='transparent';this.style.color='#dc3545'"
                        title="Delete lease"
                        onclick='deleteLease(${JSON.stringify(lease)})'>
                    <i class="bi bi-x-lg" style="font-size:0.813rem"></i>
                </button>`;

                row.innerHTML = `
                    <td><strong>${lease['ip-address']}</strong></td>
                    <td><code>${lease['hw-address']}</code></td>
                    <td>${lease.hostname || '<em>none</em>'}</td>
                    <td><span class="badge bg-info">${lease['subnet-id']}</span></td>
                    <td>${validUntil}</td>
                    <td><div class="d-flex align-items-center gap-2">${actionButton}${deleteButton}</div></td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function filterLeases() {
            const searchTerm = document.getElementById('search-filter').value.toLowerCase();
            const subnetId = document.getElementById('subnet-filter').value;
            
            let filtered = allLeases;
            
            // Filter by subnet
            if (subnetId) {
                filtered = filtered.filter(lease => 
                    lease['subnet-id'] == subnetId
                );
            }
            
            // Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(lease => 
                    lease['ip-address'].toLowerCase().includes(searchTerm) ||
                    lease['hw-address'].toLowerCase().includes(searchTerm) ||
                    (lease.hostname || '').toLowerCase().includes(searchTerm)
                );
            }
            
            displayLeases(filtered);
        }

        function showEvictionDetails(currentIP, reservedIP, macAddress) {
            alert(
                `Eviction Notice\n\n` +
                `Current Lease IP: ${currentIP}\n` +
                `MAC Address: ${macAddress}\n` +
                `Reserved IP: ${reservedIP}\n\n` +
                `This device has a reservation for ${reservedIP}.\n` +
                `The current lease will not be renewed.\n` +
                `The device will move to ${reservedIP} on the next DHCP request.`
            );
        }

        function promoteLease(lease) {
            selectedLease = lease;
            
            // Populate form with lease data
            document.getElementById('promote-ip-address').value = lease['ip-address'];
            document.getElementById('promote-mac-address').value = lease['hw-address'];
            document.getElementById('promote-hostname').value = lease.hostname || '';
            document.getElementById('promote-subnet').textContent = lease['subnet-id'];
            
            // Clear any previous validation messages
            const validationMsg = document.getElementById('ip-validation-message');
            validationMsg.style.display = 'none';
            validationMsg.className = '';
            
            // Enable the confirm button
            document.getElementById('confirm-promote-btn').disabled = false;
            
            // Add IP validation on change
            const ipInput = document.getElementById('promote-ip-address');
            ipInput.removeEventListener('input', validatePromoteIP);
            ipInput.addEventListener('input', validatePromoteIP);
            
            promoteModal.show();
        }
        
        async function validatePromoteIP() {
            const ipInput = document.getElementById('promote-ip-address');
            const newIP = ipInput.value.trim();
            const originalIP = selectedLease['ip-address'];
            const validationMsg = document.getElementById('ip-validation-message');
            const confirmBtn = document.getElementById('confirm-promote-btn');
            const subnetId = selectedLease['subnet-id'];
            
            // If IP hasn't changed, no validation needed
            if (newIP === originalIP) {
                validationMsg.style.display = 'none';
                confirmBtn.disabled = false;
                return;
            }
            
            // Basic IP format validation
            const ipPattern = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            if (!ipPattern.test(newIP)) {
                validationMsg.className = 'alert alert-warning';
                validationMsg.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Please enter a valid IP address';
                validationMsg.style.display = 'block';
                confirmBtn.disabled = true;
                return;
            }
            
            // Validate IP is in subnet range
            try {
                const validateResponse = await authFetch('/api/validate-ip', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ip_address: newIP,
                        subnet_id: subnetId
                    })
                });
                
                const validateData = await validateResponse.json();
                
                if (!validateData.success || !validateData.valid) {
                    validationMsg.className = 'alert alert-danger';
                    validationMsg.innerHTML = `<i class="bi bi-exclamation-circle"></i> <strong>Invalid IP!</strong> ${validateData.error || 'IP is not valid for this subnet'}`;
                    validationMsg.style.display = 'block';
                    confirmBtn.disabled = true;
                    return;
                }
            } catch (error) {
                console.error('Error validating subnet:', error);
                // Continue with other validations if subnet check fails
            }
            
            // Check if a reservation exists for this IP
            const existingReservation = allReservations.find(r => r['ip-address'] === newIP);
            
            if (existingReservation) {
                validationMsg.className = 'alert alert-danger';
                validationMsg.innerHTML = `<i class="bi bi-exclamation-circle"></i> <strong>Conflict!</strong> A reservation already exists for IP ${newIP}` +
                    `<br><small>MAC: ${existingReservation['hw-address']}${existingReservation.hostname ? ', Hostname: ' + existingReservation.hostname : ''}</small>`;
                validationMsg.style.display = 'block';
                confirmBtn.disabled = true;
                return;
            }
            
            // IP is valid and available
            validationMsg.className = 'alert alert-success';
            validationMsg.innerHTML = '<i class="bi bi-check-circle"></i> IP address is valid and available';
            validationMsg.style.display = 'block';
            confirmBtn.disabled = false;
        }

        async function confirmPromotion() {
            if (!selectedLease) return;
            
            // Get values from the form
            const ipAddress = document.getElementById('promote-ip-address').value.trim();
            const hostname = document.getElementById('promote-hostname').value.trim();
            const dnsServers = document.getElementById('promote-dns-servers').value.trim();
            const originalIP = selectedLease['ip-address'];
            const subnetId = selectedLease['subnet-id'];
            
            // Validate IP format
            const ipPattern = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            if (!ipPattern.test(ipAddress)) {
                alert('Please enter a valid IP address');
                return;
            }
            
            // If IP changed, do final validations
            if (ipAddress !== originalIP) {
                // Validate subnet
                try {
                    const validateResponse = await authFetch('/api/validate-ip', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ip_address: ipAddress,
                            subnet_id: subnetId
                        })
                    });
                    
                    const validateData = await validateResponse.json();
                    
                    if (!validateData.success || !validateData.valid) {
                        alert(`Cannot create reservation: ${validateData.error || 'IP is not valid for this subnet'}`);
                        return;
                    }
                } catch (error) {
                    console.error('Error validating subnet:', error);
                    alert('Failed to validate IP address. Please try again.');
                    return;
                }
                
                // Check for reservation conflicts
                const existingReservation = allReservations.find(r => r['ip-address'] === ipAddress);
                if (existingReservation) {
                    alert(`Cannot create reservation: A reservation already exists for IP ${ipAddress}`);
                    return;
                }
            }
            
            try {
                const response = await authFetch('/api/promote', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ip_address: ipAddress,
                        hw_address: selectedLease['hw-address'],
                        hostname: hostname,
                        subnet_id: subnetId,
                        dns_servers: dnsServers
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    promoteModal.hide();
                    
                    // Show success message
                    let successMsg = 'Successfully promoted lease to reservation';
                    if (ipAddress !== originalIP) {
                        successMsg += ` with new IP ${ipAddress} (was ${originalIP})`;
                    }
                    if (hostname && hostname !== selectedLease.hostname) {
                        successMsg += ` and hostname "${hostname}"`;
                    }
                    showAlert('success', successMsg);
                    
                    // Refresh leases and reservations
                    await loadReservations();
                    setTimeout(() => loadLeases(), 1000);
                } else {
                    throw new Error(data.error || 'Failed to promote lease');
                }
            } catch (error) {
                promoteModal.hide();
                alert(`Error: ${error.message}`);
            }
        }

        async function showReservations() {
            reservationsModal.show();
            
            document.getElementById('reservations-loading').style.display = 'block';
            document.getElementById('reservations-content').style.display = 'none';
            
            try {
                await loadReservations();
                
                const tbody = document.getElementById('reservations-tbody');
                tbody.innerHTML = '';
                
                if (allReservations.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No reservations found</td></tr>';
                } else {
                    // Sort reservations by IP address
                    const sortedReservations = [...allReservations].sort((a, b) => {
                        const ipA = a['ip-address'].split('.').map(num => parseInt(num));
                        const ipB = b['ip-address'].split('.').map(num => parseInt(num));

                        for (let i = 0; i < 4; i++) {
                            if (ipA[i] !== ipB[i]) {
                                return ipA[i] - ipB[i];
                            }
                        }
                        return 0;
                    });

                    sortedReservations.forEach(res => {
                        const row = document.createElement('tr');
                        const dnsServers = res['dns-servers'] || '';
                        const dnsDisplay = dnsServers ? `<code style="font-size: 0.85em;">${dnsServers}</code>` : '<span class="text-muted">Default</span>';

                        row.innerHTML = `
                            <td><strong>${res['ip-address']}</strong></td>
                            <td><code>${res['hw-address']}</code></td>
                            <td>${res.hostname || '<em>none</em>'}</td>
                            <td>${res.subnet || res['subnet-id']}</td>
                            <td>${dnsDisplay}</td>
                            <td>
                                <button class="btn btn-primary btn-sm action-btn me-1"
                                        onclick='editReservation(${JSON.stringify(res)})'>
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button class="btn btn-danger btn-sm action-btn"
                                        onclick='deleteReservation(${JSON.stringify(res)})'>
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
                
                document.getElementById('reservations-loading').style.display = 'none';
                document.getElementById('reservations-content').style.display = 'block';
            } catch (error) {
                console.error('Failed to load reservations:', error);
            }
        }

        function showAddReservationModal() {
            // Clear form
            document.getElementById('add-reservation-form').reset();
            addReservationModal.show();
        }

        async function confirmAddReservation() {
            const ipAddress = document.getElementById('new-ip-address').value.trim();
            const hwAddress = document.getElementById('new-hw-address').value.trim();
            const hostname = document.getElementById('new-hostname').value.trim();
            const dnsServers = document.getElementById('new-dns-servers').value.trim();
            const subnetId = document.getElementById('new-subnet-id').value;

            if (!ipAddress || !hwAddress) {
                alert('IP Address and MAC Address are required');
                return;
            }

            try {
                const response = await authFetch('/api/reservations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ip_address: ipAddress,
                        hw_address: hwAddress,
                        hostname: hostname,
                        subnet_id: subnetId ? parseInt(subnetId) : null,
                        dns_servers: dnsServers
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addReservationModal.hide();
                    
                    // Show success message
                    showAlert('success', data.message);
                    
                    // Refresh data
                    await loadReservations();
                    setTimeout(() => loadLeases(), 1000);
                } else {
                    throw new Error(data.error || 'Failed to create reservation');
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        function editReservation(reservation) {
            editingReservation = reservation;

            document.getElementById('edit-ip-address').value = reservation['ip-address'];
            document.getElementById('edit-hw-address').value = reservation['hw-address'];
            document.getElementById('edit-hostname').value = reservation.hostname || '';
            document.getElementById('edit-dns-servers').value = reservation['dns-servers'] || '';
            document.getElementById('edit-subnet-id').value = reservation['subnet-id'] || '';

            editReservationModal.show();
        }

        async function confirmEditReservation() {
            if (!editingReservation) return;

            const ipAddress = document.getElementById('edit-ip-address').value.trim();
            const hwAddress = document.getElementById('edit-hw-address').value.trim();
            const hostname = document.getElementById('edit-hostname').value.trim();
            const dnsServers = document.getElementById('edit-dns-servers').value.trim();
            const subnetId = document.getElementById('edit-subnet-id').value;

            if (!ipAddress || !hwAddress) {
                alert('IP Address and MAC Address are required');
                return;
            }

            try {
                // Delete old reservation
                const oldIpAddress = editingReservation['ip-address'];
                const oldSubnetId = editingReservation['subnet-id'];

                let deleteUrl = `/api/reservation/${encodeURIComponent(oldIpAddress)}`;
                if (oldSubnetId) {
                    deleteUrl += `?subnet_id=${oldSubnetId}`;
                }

                await authFetch(deleteUrl, {
                    method: 'DELETE'
                });

                // Create new reservation with updated values
                const response = await authFetch('/api/reservations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ip_address: ipAddress,
                        hw_address: hwAddress,
                        hostname: hostname,
                        subnet_id: subnetId ? parseInt(subnetId) : null,
                        dns_servers: dnsServers
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    editReservationModal.hide();
                    
                    // Show success message
                    showAlert('success', 'Reservation updated successfully');
                    
                    // Refresh data
                    await loadReservations();
                    setTimeout(() => {
                        loadLeases();
                        // If reservations modal is still open, refresh it
                        if (reservationsModal._isShown) {
                            showReservations();
                        }
                    }, 1000);
                } else {
                    throw new Error(data.error || 'Failed to update reservation');
                }
            } catch (error) {
                alert(`Error updating reservation: ${error.message}`);
            }
        }

        function deleteReservation(reservation) {
            selectedReservation = reservation;
            
            document.getElementById('delete-modal-ip').textContent = reservation['ip-address'];
            document.getElementById('delete-modal-mac').textContent = reservation['hw-address'];
            document.getElementById('delete-modal-hostname').textContent = reservation.hostname || 'none';
            
            deleteReservationModal.show();
        }

        async function confirmDeleteReservation() {
            if (!selectedReservation) return;
            
            try {
                const ipAddress = selectedReservation['ip-address'];
                const subnetId = selectedReservation['subnet-id'];
                
                let url = `/api/reservation/${encodeURIComponent(ipAddress)}`;
                if (subnetId) {
                    url += `?subnet_id=${subnetId}`;
                }

                const response = await authFetch(url, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    deleteReservationModal.hide();
                    
                    // Show success message
                    showAlert('success', data.message);
                    
                    // Refresh data
                    await loadReservations();
                    setTimeout(() => {
                        loadLeases();
                        // If reservations modal is still open, refresh it
                        if (reservationsModal._isShown) {
                            showReservations();
                        }
                    }, 1000);
                } else {
                    throw new Error(data.error || 'Failed to delete reservation');
                }
            } catch (error) {
                deleteReservationModal.hide();
                alert(`Error: ${error.message}`);
            }
        }

        function deleteLease(lease) {
            selectedLease = lease;

            if (confirmLeaseDelete) {
                document.getElementById('delete-lease-modal-ip').textContent = lease['ip-address'];
                document.getElementById('delete-lease-modal-mac').textContent = lease['hw-address'];
                document.getElementById('delete-lease-modal-hostname').textContent = lease.hostname || 'none';
                deleteLeaseModal.show();
            } else {
                performDeleteLease(lease['ip-address']);
            }
        }

        async function confirmDeleteLease() {
            if (!selectedLease) return;
            deleteLeaseModal.hide();
            await performDeleteLease(selectedLease['ip-address']);
        }

        async function performDeleteLease(ipAddress) {
            try {
                const response = await authFetch(`/api/leases/ip/${encodeURIComponent(ipAddress)}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (data.success) {
                    showAlert('success', `Lease for ${ipAddress} deleted`);
                    loadLeases();
                } else {
                    throw new Error(data.error || 'Failed to delete lease');
                }
            } catch (error) {
                alert(`Error deleting lease: ${error.message}`);
            }
        }

        function showAlert(type, message) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show mt-3`;
            alert.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert at the top of the container
            const container = document.querySelector('.container-fluid');
            const firstChild = container.firstChild;
            container.insertBefore(alert, firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function showAlertInModal(type, message) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show mb-3`;
            alert.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert at the top of the reservations modal body
            const modalBody = document.querySelector('#reservationsModal .modal-body');
            const firstChild = modalBody.firstChild;
            modalBody.insertBefore(alert, firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        async function showConfigModal() {
            configModal.show();
            
            document.getElementById('config-loading').style.display = 'block';
            document.getElementById('config-form').style.display = 'none';
            
            try {
                const response = await authFetch('/api/config');
                const data = await response.json();

                if (data.success) {
                    const cfg = data.config;
                    
                    // Populate form fields
                    document.getElementById('config-kea-url').value = cfg.kea.control_agent_url || '';
                    document.getElementById('config-kea-username').value = cfg.kea.username || '';
                    document.getElementById('config-kea-password').value = cfg.kea.password || '';
                    document.getElementById('config-kea-subnet').value = cfg.kea.default_subnet_id || 1;
                    
                    document.getElementById('config-app-host').value = cfg.app.host || '0.0.0.0';
                    document.getElementById('config-app-port').value = cfg.app.port || 5000;
                    document.getElementById('config-app-debug').checked = cfg.app.debug || false;
                    const confirmPref = cfg.app.confirm_lease_delete !== false;
                    document.getElementById('config-confirm-lease-delete').checked = confirmPref;
                    
                    document.getElementById('config-log-level').value = cfg.logging.level || 'INFO';

                    // Populate API token field
                    document.getElementById('config-api-token').value = cfg.app.api_token || '';
                    // Reset visibility to hidden when modal opens
                    document.getElementById('config-api-token').type = 'password';
                    document.getElementById('api-token-eye-icon').className = 'bi bi-eye';

                    // Show config file status
                    const statusEl = document.getElementById('config-file-status');
                    if (data.config_exists) {
                        statusEl.innerHTML = `<strong>Config file:</strong> ${data.config_path} (exists)`;
                        statusEl.className = 'text-success';
                    } else {
                        statusEl.innerHTML = `<strong>Config file:</strong> ${data.config_path} (will be created)`;
                        statusEl.className = 'text-warning';
                    }
                    
                    document.getElementById('config-loading').style.display = 'none';
                    document.getElementById('config-form').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load config:', error);
                alert('Failed to load configuration: ' + error.message);
                configModal.hide();
            }
        }

        function toggleApiTokenVisibility() {
            const input = document.getElementById('config-api-token');
            const icon = document.getElementById('api-token-eye-icon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'bi bi-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'bi bi-eye';
            }
        }

        async function copyApiToken() {
            const token = document.getElementById('config-api-token').value;
            try {
                await navigator.clipboard.writeText(token);
                showAlert('success', 'API token copied to clipboard.');
            } catch {
                showAlert('warning', 'Could not copy to clipboard.');
            }
        }

        async function regenerateApiToken() {
            if (!confirm('Regenerate the API token? All existing API sessions will be invalidated and you will be logged out.')) return;
            try {
                const resp = await authFetch('/api/auth/token/regenerate', { method: 'POST' });
                const data = await resp.json();
                if (data.success) {
                    localStorage.setItem(AUTH_TOKEN_KEY, data.api_token);
                    document.getElementById('config-api-token').value = data.api_token;
                    showAlert('success', 'API token regenerated. Your session has been updated.');
                } else {
                    showAlert('danger', 'Failed to regenerate token: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                showAlert('danger', 'Error: ' + err.message);
            }
        }

        async function saveConfiguration() {
            const saveBtn = document.getElementById('save-config-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
            
            try {
                const newConfig = {
                    kea: {
                        control_agent_url: document.getElementById('config-kea-url').value,
                        username: document.getElementById('config-kea-username').value,
                        password: document.getElementById('config-kea-password').value,
                        default_subnet_id: parseInt(document.getElementById('config-kea-subnet').value)
                    },
                    app: {
                        host: document.getElementById('config-app-host').value,
                        port: parseInt(document.getElementById('config-app-port').value),
                        debug: document.getElementById('config-app-debug').checked,
                        confirm_lease_delete: document.getElementById('config-confirm-lease-delete').checked
                    },
                    logging: {
                        level: document.getElementById('config-log-level').value,
                        format: '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
                    }
                };
                
                const response = await authFetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        config: newConfig
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Sync lease delete confirmation preference immediately
                    confirmLeaseDelete = newConfig.app.confirm_lease_delete;
                    localStorage.setItem('confirmLeaseDelete', confirmLeaseDelete);

                    configModal.hide();
                    showAlert('success', data.message + ' Reloading page...');
                    
                    // Reload the page after a short delay to apply new configuration
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    throw new Error(data.error || 'Failed to save configuration');
                }
            } catch (error) {
                alert(`Error saving configuration: ${error.message}`);
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="bi bi-save"></i> Save Configuration';
            }
        }

        async function refreshData() {
            const health = await checkHealth();
            if (!health || health.status === 'unconfigured') {
                showUnconfiguredState();
                return;
            }
            loadReservations().then(() => {
                loadLeases();
            });
        }

        // Export reservations to JSON file
        async function exportReservations() {
            try {
                const subnetFilter = document.getElementById('subnet-filter').value;
                let url = '/api/reservations/export';

                if (subnetFilter) {
                    url += `?subnet_id=${subnetFilter}`;
                }

                const response = await authFetch(url);
                if (!response || !response.ok) throw new Error('Export request failed');
                const blob = await response.blob();
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'dhcp_reservations_export.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);

                showAlertInModal('success', 'Reservations exported successfully.');
            } catch (error) {
                console.error('Export failed:', error);
                showAlertInModal('danger', `Error exporting reservations: ${error.message}`);
            }
        }

        // Show import modal
        function showImportModal() {
            // Reset modal state
            document.getElementById('import-file-select').style.display = 'block';
            document.getElementById('import-progress').style.display = 'none';
            document.getElementById('import-results').style.display = 'none';
            document.getElementById('import-file').value = '';
            document.getElementById('import-btn').style.display = 'inline-block';
            
            importModal.show();
        }

        // Import reservations from file
        async function confirmImport() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file to import');
                return;
            }
            
            // Show progress
            document.getElementById('import-file-select').style.display = 'none';
            document.getElementById('import-progress').style.display = 'block';
            document.getElementById('import-btn').style.display = 'none';
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await authFetch('/api/reservations/import', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                // Hide progress
                document.getElementById('import-progress').style.display = 'none';
                
                if (data.success) {
                    // Show results
                    document.getElementById('import-results').style.display = 'block';
                    
                    // Create summary message
                    let summaryHtml = '';
                    if (data.success_count > 0 && data.failed_count === 0) {
                        summaryHtml = `
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle"></i>
                                <strong>Success!</strong> ${data.success_count} reservation(s) imported successfully.
                            </div>
                        `;
                    } else if (data.success_count > 0 && data.failed_count > 0) {
                        summaryHtml = `
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>Partial Success</strong><br>
                                ${data.success_count} reservation(s) imported successfully.<br>
                                ${data.failed_count} reservation(s) failed to import.<br>
                                <small>${data.hint || ''}</small>
                            </div>
                        `;
                    } else {
                        summaryHtml = `
                            <div class="alert alert-danger">
                                <i class="bi bi-x-circle"></i>
                                <strong>Import Failed</strong><br>
                                All ${data.failed_count} reservation(s) failed to import.<br>
                                <small>${data.hint || ''}</small>
                            </div>
                        `;
                    }
                    
                    document.getElementById('import-summary').innerHTML = summaryHtml;
                    
                    // Show failed items if any
                    if (data.failed_count > 0 && data.failed_items) {
                        document.getElementById('import-failed-items').style.display = 'block';
                        
                        const tbody = document.getElementById('failed-items-tbody');
                        tbody.innerHTML = '';
                        
                        data.failed_items.forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${item.index}</td>
                                <td>${item.ip || 'N/A'}</td>
                                <td>${item.mac || 'N/A'}</td>
                                <td><small>${item.error}</small></td>
                            `;
                            tbody.appendChild(row);
                        });
                    } else {
                        document.getElementById('import-failed-items').style.display = 'none';
                    }
                    
                    // Refresh data if any succeeded
                    if (data.success_count > 0) {
                        await loadReservations();
                        setTimeout(() => loadLeases(), 1000);
                        
                        // Refresh the reservations modal view if it's open
                        if (reservationsModal._isShown) {
                            // Reload the reservations table
                            const tbody = document.getElementById('reservations-tbody');
                            tbody.innerHTML = '';
                            
                            if (allReservations.length === 0) {
                                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No reservations found</td></tr>';
                            } else {
                                // Sort reservations by IP address
                                const sortedReservations = [...allReservations].sort((a, b) => {
                                    const ipA = a['ip-address'].split('.').map(num => parseInt(num));
                                    const ipB = b['ip-address'].split('.').map(num => parseInt(num));
                                    
                                    for (let i = 0; i < 4; i++) {
                                        if (ipA[i] !== ipB[i]) {
                                            return ipA[i] - ipB[i];
                                        }
                                    }
                                    return 0;
                                });
                                
                                sortedReservations.forEach(res => {
                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td><strong>${res['ip-address']}</strong></td>
                                        <td><code>${res['hw-address']}</code></td>
                                        <td>${res.hostname || '<em>none</em>'}</td>
                                        <td>${res.subnet || res['subnet-id']}</td>
                                        <td>
                                            <button class="btn btn-primary btn-sm action-btn me-1" 
                                                    onclick='editReservation(${JSON.stringify(res)})'>
                                                <i class="bi bi-pencil"></i> Edit
                                            </button>
                                            <button class="btn btn-danger btn-sm action-btn" 
                                                    onclick='deleteReservation(${JSON.stringify(res)})'>
                                                <i class="bi bi-trash"></i> Delete
                                            </button>
                                        </td>
                                    `;
                                    tbody.appendChild(row);
                                });
                            }
                        }
                    }
                } else {
                    // Show error
                    document.getElementById('import-results').style.display = 'block';
                    document.getElementById('import-summary').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle"></i>
                            <strong>Import Failed</strong><br>
                            ${data.error || 'Unknown error occurred'}
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('import-progress').style.display = 'none';
                document.getElementById('import-results').style.display = 'block';
                document.getElementById('import-summary').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle"></i>
                        <strong>Import Failed</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // Kea Config Modal Functions
        async function showKeaConfigModal() {
            keaConfigModal.show();

            // Reset view state
            document.getElementById('kea-config-loading').style.display = 'block';
            document.getElementById('kea-config-error').style.display = 'none';
            document.getElementById('kea-config-curation-warning').style.display = 'none';
            document.getElementById('kea-config-curated').style.display = 'none';
            document.getElementById('kea-config-raw').style.display = 'none';

            // Reset toggle to curated view and enable both buttons
            document.getElementById('viewCurated').checked = true;
            document.getElementById('viewCurated').disabled = false;
            document.getElementById('viewRaw').disabled = false;

            try {
                const response = await authFetch('/api/kea-config');
                const data = await response.json();

                if (data.success) {
                    keaConfigData = data;

                    // Always render raw view (always available)
                    renderRawView(data.config);

                    // Check if curation succeeded
                    if (data.curated) {
                        // Curation succeeded - render curated view
                        renderCuratedView(data.curated);

                        // Show curated view by default
                        document.getElementById('kea-config-loading').style.display = 'none';
                        document.getElementById('kea-config-curated').style.display = 'block';
                    } else if (data.curation_error) {
                        // Curation failed but we have raw config
                        console.warn('Curation failed:', data.curation_error);

                        // Show warning banner
                        document.getElementById('kea-config-curation-warning-text').textContent = data.curation_error;
                        document.getElementById('kea-config-curation-warning').style.display = 'block';

                        // Disable curated view button and switch to raw view
                        document.getElementById('viewCurated').disabled = true;
                        document.getElementById('viewRaw').checked = true;

                        // Show raw view
                        document.getElementById('kea-config-loading').style.display = 'none';
                        document.getElementById('kea-config-raw').style.display = 'block';
                    } else {
                        // Unexpected: success but no curated data and no error
                        throw new Error('Configuration received but curation data is missing');
                    }
                } else {
                    throw new Error(data.error || 'Failed to load Kea configuration');
                }
            } catch (error) {
                console.error('Failed to load Kea config:', error);
                document.getElementById('kea-config-loading').style.display = 'none';
                document.getElementById('kea-config-error-text').textContent = error.message;
                document.getElementById('kea-config-error').style.display = 'block';
            }
        }

        function renderCuratedView(curated) {
            // Safety check
            if (!curated) {
                console.error('renderCuratedView called with null/undefined data');
                return;
            }

            // Render Global Settings
            const globalContent = document.getElementById('global-settings-content');
            let globalHtml = '<dl class="row mb-0">';

            // Default Lease Time
            if (curated.global.valid_lifetime !== null && curated.global.valid_lifetime !== undefined) {
                globalHtml += `
                    <dt class="col-sm-4">Default Lease Time</dt>
                    <dd class="col-sm-8">${curated.global.valid_lifetime}s <span class="text-muted">(${curated.global.valid_lifetime_formatted})</span></dd>
                `;
            }

            // Renew Timer (T1)
            if (curated.global.renew_timer !== null && curated.global.renew_timer !== undefined) {
                globalHtml += `
                    <dt class="col-sm-4">Renew Timer (T1)</dt>
                    <dd class="col-sm-8">${curated.global.renew_timer}s <span class="text-muted">(${curated.global.renew_timer_formatted})</span></dd>
                `;
            }

            // Rebind Timer (T2)
            if (curated.global.rebind_timer !== null && curated.global.rebind_timer !== undefined) {
                globalHtml += `
                    <dt class="col-sm-4">Rebind Timer (T2)</dt>
                    <dd class="col-sm-8">${curated.global.rebind_timer}s <span class="text-muted">(${curated.global.rebind_timer_formatted})</span></dd>
                `;
            }

            // Interfaces
            if (curated.global.interfaces && curated.global.interfaces.length > 0) {
                globalHtml += `
                    <dt class="col-sm-4">Interfaces</dt>
                    <dd class="col-sm-8"><code>${curated.global.interfaces.join(', ')}</code></dd>
                `;
            }

            // Lease Database
            if (curated.global.lease_database && Object.keys(curated.global.lease_database).length > 0) {
                const db = curated.global.lease_database;
                let dbInfo = db.type || 'unknown';
                if (db.persist !== undefined) {
                    dbInfo += db.persist ? ' (persistent)' : ' (non-persistent)';
                }
                globalHtml += `
                    <dt class="col-sm-4">Lease Database</dt>
                    <dd class="col-sm-8">${dbInfo}</dd>
                `;
            }

            globalHtml += '</dl>';
            globalContent.innerHTML = globalHtml;

            // Render Subnets
            const subnetsContainer = document.getElementById('subnets-accordion-container');
            subnetsContainer.innerHTML = '';

            curated.subnets.forEach((subnet, index) => {
                const subnetId = `collapseSubnet${subnet.id}`;
                const isFirst = index === 0;

                let subnetHtml = `
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button ${isFirst ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#${subnetId}" aria-expanded="${isFirst}" aria-controls="${subnetId}">
                                <i class="bi bi-diagram-2 me-2"></i> Subnet ${subnet.id}: ${subnet.subnet}
                                <span class="badge bg-secondary ms-2">${subnet.reservation_count} reservations</span>
                            </button>
                        </h2>
                        <div id="${subnetId}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}" data-bs-parent="#keaConfigAccordion">
                            <div class="accordion-body">
                                <dl class="row mb-0">
                `;

                // Pools
                if (subnet.pools && subnet.pools.length > 0) {
                    subnetHtml += `
                        <dt class="col-sm-4">Pools</dt>
                        <dd class="col-sm-8"><code>${subnet.pools.join('<br>')}</code></dd>
                    `;
                }

                // Lease Time (if different from global)
                if (subnet.valid_lifetime !== null && subnet.valid_lifetime !== undefined) {
                    subnetHtml += `
                        <dt class="col-sm-4">Lease Time</dt>
                        <dd class="col-sm-8">${subnet.valid_lifetime}s <span class="text-muted">(${subnet.valid_lifetime_formatted})</span></dd>
                    `;
                } else {
                    subnetHtml += `
                        <dt class="col-sm-4">Lease Time</dt>
                        <dd class="col-sm-8"><span class="text-muted">(using global default)</span></dd>
                    `;
                }

                // Router
                if (subnet.options.routers) {
                    subnetHtml += `
                        <dt class="col-sm-4">Router</dt>
                        <dd class="col-sm-8"><code>${subnet.options.routers}</code></dd>
                    `;
                }

                // DNS Servers
                if (subnet.options.dns_servers) {
                    subnetHtml += `
                        <dt class="col-sm-4">DNS Servers</dt>
                        <dd class="col-sm-8"><code>${subnet.options.dns_servers}</code></dd>
                    `;
                }

                // Reservation count
                subnetHtml += `
                    <dt class="col-sm-4">Reservations</dt>
                    <dd class="col-sm-8">${subnet.reservation_count}</dd>
                `;

                subnetHtml += `
                                </dl>
                            </div>
                        </div>
                    </div>
                `;

                subnetsContainer.innerHTML += subnetHtml;
            });

            // Render Advanced Settings
            const advancedContent = document.getElementById('advanced-settings-content');
            let advancedHtml = '<dl class="row mb-0">';

            // Hooks Libraries
            if (curated.advanced.hooks_libraries && curated.advanced.hooks_libraries.length > 0) {
                advancedHtml += `
                    <dt class="col-sm-4">Hooks Libraries</dt>
                    <dd class="col-sm-8">
                        <ul class="list-unstyled mb-0">
                            ${curated.advanced.hooks_libraries.map(h => `<li><code>${h}</code></li>`).join('')}
                        </ul>
                    </dd>
                `;
            } else {
                advancedHtml += `
                    <dt class="col-sm-4">Hooks Libraries</dt>
                    <dd class="col-sm-8"><span class="text-muted">None configured</span></dd>
                `;
            }

            // Control Socket
            if (curated.advanced.control_socket && curated.advanced.control_socket.type) {
                advancedHtml += `
                    <dt class="col-sm-4">Control Socket</dt>
                    <dd class="col-sm-8">
                        Type: <code>${curated.advanced.control_socket.type}</code><br>
                        Path: <code>${curated.advanced.control_socket.path}</code>
                    </dd>
                `;
            }

            // Host Reservation Identifiers
            if (curated.advanced.host_reservation_identifiers && curated.advanced.host_reservation_identifiers.length > 0) {
                advancedHtml += `
                    <dt class="col-sm-4">Reservation Identifiers</dt>
                    <dd class="col-sm-8"><code>${curated.advanced.host_reservation_identifiers.join(', ')}</code></dd>
                `;
            }

            advancedHtml += '</dl>';
            advancedContent.innerHTML = advancedHtml;
        }

        function renderRawView(config) {
            const jsonContainer = document.getElementById('kea-config-json').querySelector('code');
            jsonContainer.textContent = JSON.stringify(config, null, 2);
        }

        // Auto-refresh every 30 seconds
        setInterval(refreshData, 30000);
    </script>
</body>
</html>
